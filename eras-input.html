<link rel='import' href='../polymer/polymer.html'>
<link rel='import' href='../iron-form-element-behavior/iron-form-element-behavior.html'>
<link rel='import' href='../iron-icon/iron-icon.html'>
<link rel='import' href='../iron-input/iron-input.html'>
<link rel='import' href='../paper-input/paper-input-container.html'>
<link rel='import' href='../paper-input/paper-input-error.html'>
<link rel='import' href='../eras-input/validators/eras-input-regex-validator.html'>

<!--
`eras-input`

### Important:
It looks like there is [some issues](https://github.com/PolymerElements/iron-form-element-behavior/issues/28) when trying to use `IronFormElementBehavior` togehter
with `IronValidatableBehavior`. Basically the validate methods on `IronValidatorBehavior` elements used by `IronValidatableBehavior` requires the value to be validated 
to be passed to it, where as the validate method specified by `IronFormElementBehavior` takes no arguments. So when `iron-form` tries to validate an element implementing 
`IronValidatableBehavior` it never gets the value given to it. 

It seems the only way round it is to drop the `IronValidatableBehavior` and `IronValidatorBehavior` combo all together and just implement the validate method (without any args)
insed the element implementing `IronFormElementBehavior`... fun times!

@demo demo/eras-input_demo.html
-->
<dom-module id='eras-input'>
  <template>
    <style>
       :host {
        display: block;
        padding-bottom: 10px;
      }

       :host([hidden]) {
        display: none !important;
      }

      paper-input-container ::content iron-icon {
        margin-right: 5px;
      }
    </style>
    <content id='validators' select='.validator'></content>
    <!-- <iron-a11y-keys id='a11y' target='[[target]]' keys='enter' on-keys-pressed='onEnter'></iron-a11y-keys> -->
    <paper-input-container id='container' invalid$='{{invalid}}' disabled$='{{disabled}}' always-float-label$='{{_floatLabel}}'>
      <template is='dom-if' if='{{icon}}'>
        <iron-icon icon='{{icon}}' prefix></iron-icon>
      </template>
      <content id='content'></content>
      <template is='dom-if' if='{{label}}'>
        <label>{{label}}</label>
      </template>
      <input id='input' is='iron-input' on-blur='_onBlur' on-focus='_onFocus' name='{{name}}' bind-value='{{value}}' readonly$={{readonly}}
        type$='{{type}}' autocomplete$='{{autocomplete}}' prevent-invalid-input$='_preventInvalidInput' allowed-pattern$='{{allowedPattern}}' />
      <paper-input-error>{{errorMessage}}</paper-input-error>
    </paper-input-container>
  </template>
  <script>
    Polymer({
      is: 'eras-input',
      properties: {
        /** The value of this input. */
        value: {
          type: String,
          observer: '_valueChanged'
        },

        /** 
         * The name of this input that will be associated with the value
         * when submitted.
         */
        name: String,

        /** The label to be used for this input. *Optional* */
        label: String,

        /** Name of the icon to prefix this input with. *Optional* */
        icon: String,

        /** The type of input, passed directly to the input element. */
        type: {
          type: String,
          value: 'text'
        },

        /** The type of autocomplete to use, passed directly to the element */
        autocomplete: {
          type: String,
          value: 'off'
        },

        /**
         * Use this to only allow users to enter certain characters.
         * @type {String} regex style pattern to specify allowed characters (e.g. [0-9] or [a-zA-Z])
         */
         allowedPattern: String,

         /** Computed value that states whether invalid input should be prevented. */
         _preventInvalidInput: {
           type: Boolean,
           computed: '_computePreventInvalidInput(allowedPattern)'
         },

        /** The message to display when invalid. */
        errorMessage: String,

        /** Returns true if the value is invalid. */
        invalid: {
          reflectToAttribute: true,
          type: Boolean,
          value: false
        },

        /**  
         * States whether or not the value will be vaildated upon every change.
         * Gets set to true in `ready()` and `_onBlur()`
         */
        autoValidate: {
          type: Boolean,
          value: false
        },

        /** Set to true to disable this input. */
        disabled: {
          reflectToAttribute: true,
          type: Boolean,
          value: false
        },

        /** Set to true to make this input readonly. */
        readonly: {
          reflectToAttribute: true,
          type: Boolean,
          value: false
        },
      },

      behaviors: [
        Polymer.IronFormElementBehavior
      ],

      ready: function () {
        if (this.value !== undefined && this.value.length > 0)
          this.autoValidate = true;
      },

      /**
       * Gets the supplied validators as an array. 
       * Validators must have a class of `.validator` to be picked up.
       * @return {Element[]} Implementations of `Eras.InputValidatorBehavior`
       */
      _getValidators: function () {
        return this.getContentChildren('#validators');
      },

      /**
       * Validates the current value of the input against
       * all supplied validators.
       * @return {Boolean} false if invalid, true if not
       */
      validate: function () {
        var validators = this._getValidators();

        for (var i = 0; i < validators.length; i++) {
          if (!validators[i].validate(this.value)) {
            this.invalid = true;
            this.errorMessage = validators[i].message;
            return false; // not valid
          }
        }

        this.invalid = false;
        return true; // if all validators passed
      },

      /**
       * If `autoValidate` is set to true then calls `validate()` 
       * on every change to `value`
       * @param {Object} value       
       */
      _valueChanged: function (value) {
        if (this.autoValidate)
          this.validate();
      },

      /**
       * Called when the user focuses on this element. 
       * Copies attributes from the validators to the input.
       */
      _onFocus: function () {
        var validators = this._getValidators();
        for (var i = 0; i < validators.length; i++) 
          validators[i].copyAttributes(this.$.input);
      },

      /**
       * Called when the user clicks off this element. 
       * Sets `autoValidate` to true and calls `validate()`.
       */
      _onBlur: function () {
        this.autoValidate = true;
        this.validate();
      },

      /**
       * Computes `_preventInvalidInput`
       * @return {Boolean} true if invalid input will be prevented
       */
      _computePreventInvalidInput: function(allowedPattern) {
        if(allowedPattern)
          return true;
        else 
          return false;
      }
    });
  </script>
</dom-module>